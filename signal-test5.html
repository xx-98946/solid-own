<!doctype html>
<html lang="zh">
    <head>
        <meta charset="UTF-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>信号量测试4</title>
    </head>
    <body>
        <div>
            <div>
                <span>姓:</span>
                <input id="firstName" placeholder="请输入姓" />
            </div>
            <div>
                <span>名:</span>
                <input id="lastName" placeholder="请输入名" />
            </div>
            <div>
                <span>姓名: </span>
                <span id="fullName"></span>
            </div>
        </div>

        <script>
            const firstName = document.getElementById("firstName");
            const lastName = document.getElementById("lastName");
            const fullName = document.getElementById("fullName");

            /**
             * 定义全局监听变量，每次调用watch时修改改属性
             * 同时该变量会在`get`时被绑定
             */
            let currentSubcribe = null;

            const data = new Proxy(
                {
                    firstName: "",
                    lastName: "",
                    fullName: "",
                },
                {
                    /**
                     * 添加获取监听
                     */
                    get(obj, prop) {
                        if (currentSubcribe) {
                            dataEvents[prop].push(currentSubcribe);
                        }
                        return obj[prop];
                    },
                    set(obj, prop, newValue) {
                        obj[prop] = newValue;
                        dataEvents.update(prop);
                    },
                },
            );

            const dataEvents = {
                update(prop, newValue, oldValue) {
                    dataEvents[prop].forEach((cb) => {
                        cb();
                    });
                },
                firstName: [],
                lastName: [],
                fullName: [],
            };

            /**
             * 定义监听函数
             */
            function watch(cb) {
                currentSubcribe = cb;
                cb();
                currentSubcribe = null;
            }

            watch(function (newValue) {
                firstName.value = data.firstName;
            });

            watch(function () {
                data.fullName = data.firstName + data.lastName;
            });

            watch(function () {
                lastName.value = data.lastName;
            });

            watch(function () {
                fullName.innerText = data.fullName;
            });

            firstName.addEventListener("input", (e) => {
                data.firstName = e.target.value;
            });

            lastName.addEventListener("input", (e) => {
                data.lastName = e.target.value;
            });

            data.firstName = "姓";
            data.lastName = "名";

            console.log(dataEvents);
        </script>
    </body>
</html>
